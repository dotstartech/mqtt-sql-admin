# Run nginx as admin user
user admin admin;
pid /tmp/nginx.pid;

# Run in foreground (don't daemonize)
daemon off;

# Basic settings
worker_processes 1;
error_log /var/log/nginx/error.log;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # WebSocket upgrade support
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }
    
    # Use /tmp for nginx temp directories
    client_body_temp_path /tmp/nginx_client_body;
    proxy_temp_path /tmp/nginx_proxy;
    fastcgi_temp_path /tmp/nginx_fastcgi;
    uwsgi_temp_path /tmp/nginx_uwsgi;
    scgi_temp_path /tmp/nginx_scgi;
    
    access_log /var/log/nginx/access.log;
    
    # Enable gzip compression for text-based content
    gzip on;
    gzip_vary on;
    gzip_min_length 256;
    gzip_proxied any;
    gzip_types text/plain text/css text/javascript application/javascript application/json;
    gzip_comp_level 6;
    
    sendfile on;
    keepalive_timeout 65;
    
    server {
        listen 8080;
        server_name _;
        
        root /mosquitto;
        
        # Health check endpoint (no auth required)
        location = /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }
        
        # Redirect root to serve admin index.html
        location = / {
            rewrite ^ /admin/index.html last;
        }
        
        # Serve static files from admin directory (CSS, JS, etc.)
        # Also serves index.html via rewrite from /
        location /admin/ {
            alias /mosquitto/admin/;
            try_files $uri =404;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
        
        # Proxy /db-admin to sqld (protected with HTTP Basic Auth)
        # For AJAX requests, return 401 without WWW-Authenticate to use custom login dialog
        location /db-admin/ {
            # Check if Authorization header is present
            set $auth_required "true";
            if ($http_authorization) {
                set $auth_required "false";
            }
            
            # If no auth header, check if it's an AJAX request
            if ($http_x_requested_with = "XMLHttpRequest") {
                set $auth_required "${auth_required}_ajax";
            }
            
            # Return 401 for AJAX without auth (no WWW-Authenticate header)
            if ($auth_required = "true_ajax") {
                return 401 '{"error": "Authentication required"}';
            }
            
            # Standard Basic Auth
            auth_basic "mqBase Admin";
            auth_basic_user_file /tmp/htpasswd;
            
            # Remove /db-admin prefix and pass the rest to sqld
            rewrite ^/db-admin/(.*) /$1 break;
            proxy_pass http://localhost:8000;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_buffering off;
        }
        
        # Serve broker configuration (dynsec.json) - protected
        location = /broker-config {
            # Check if Authorization header is present
            set $auth_required "true";
            if ($http_authorization) {
                set $auth_required "false";
            }
            
            # If no auth header, check if it's an AJAX request
            if ($http_x_requested_with = "XMLHttpRequest") {
                set $auth_required "${auth_required}_ajax";
            }
            
            # Return 401 for AJAX without auth (no WWW-Authenticate header)
            if ($auth_required = "true_ajax") {
                return 401 '{"error": "Authentication required"}';
            }
            
            # Standard Basic Auth
            auth_basic "mqBase Admin";
            auth_basic_user_file /tmp/htpasswd;
            
            alias /mosquitto/config/dynsec.json;
            add_header Content-Type application/json;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
        
        # Serve MQTT credentials - protected
        location = /mqtt-credentials {
            # Check if Authorization header is present
            set $auth_required "true";
            if ($http_authorization) {
                set $auth_required "false";
            }
            
            # If no auth header, check if it's an AJAX request
            if ($http_x_requested_with = "XMLHttpRequest") {
                set $auth_required "${auth_required}_ajax";
            }
            
            # Return 401 for AJAX without auth (no WWW-Authenticate header)
            if ($auth_required = "true_ajax") {
                return 401 '{"error": "Authentication required"}';
            }
            
            # Standard Basic Auth
            auth_basic "mqBase Admin";
            auth_basic_user_file /tmp/htpasswd;
            
            alias /tmp/mqtt-credentials.json;
            add_header Content-Type application/json;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }

        # WebSocket proxy for MQTT over WebSocket
        location /mqtt/ {
            # Strip /mqtt/ and proxy to root
            proxy_pass http://localhost:9001/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_read_timeout 86400;
            proxy_send_timeout 86400;
            proxy_buffering off;
        }
        
        location = /mqtt {
            # Exact match for /mqtt (no trailing slash)
            # Proxy to root of Mosquitto
            proxy_pass http://localhost:9001/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_read_timeout 86400;
            proxy_send_timeout 86400;
            proxy_buffering off;
        }

        # Serve app configuration (title, logo from mqbase.properties) - public
        location = /app-config {
            alias /tmp/app-config.json;
            add_header Content-Type application/json;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
    }
}
