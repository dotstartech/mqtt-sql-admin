# Run nginx as admin user
user admin admin;
pid /tmp/nginx.pid;

# Run in foreground (don't daemonize)
daemon off;

# Basic settings
worker_processes 1;
error_log /var/log/nginx/error.log;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # WebSocket upgrade support
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }
    
    # Use /tmp for nginx temp directories
    client_body_temp_path /tmp/nginx_client_body;
    proxy_temp_path /tmp/nginx_proxy;
    fastcgi_temp_path /tmp/nginx_fastcgi;
    uwsgi_temp_path /tmp/nginx_uwsgi;
    scgi_temp_path /tmp/nginx_scgi;
    
    access_log /var/log/nginx/access.log;
    
    sendfile on;
    keepalive_timeout 65;
    
    server {
        listen 8080;
        server_name _;
        
        root /mosquitto;
        
        # Serve admin interface at /msg-admin (serves from admin directory)
        location = /msg-admin {
            try_files /admin/index.html =404;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
        
        # Also allow access with trailing slash
        location = /msg-admin/ {
            try_files /admin/index.html =404;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
        
        # Serve static files from admin directory (CSS, JS, etc.)
        location /admin/ {
            alias /mosquitto/admin/;
            try_files $uri =404;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
        
        # Proxy /db-admin to sqld
        location /db-admin/ {
            # Remove /db-admin prefix and pass the rest to sqld
            rewrite ^/db-admin/(.*) /$1 break;
            proxy_pass http://localhost:8000;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_buffering off;
        }
        
        # Serve broker configuration (dynsec.json)
        # Serve directly from /run/secrets (mounted by Docker)
        location = /broker-config {
            alias /run/secrets/dynsec.json;
            add_header Content-Type application/json;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
        
        # WebSocket proxy for MQTT over WebSocket
        location /mqtt/ {
            # Strip /mqtt/ and proxy to root
            proxy_pass http://localhost:9001/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_read_timeout 86400;
            proxy_send_timeout 86400;
            proxy_buffering off;
        }
        
        location = /mqtt {
            # Exact match for /mqtt (no trailing slash)
            # Proxy to root of Mosquitto
            proxy_pass http://localhost:9001/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_read_timeout 86400;
            proxy_send_timeout 86400;
            proxy_buffering off;
        }

        # Serve MQTT credentials
        location = /mqtt-credentials {
            alias /tmp/mqtt-credentials.json;
            add_header Content-Type application/json;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
    }
}

