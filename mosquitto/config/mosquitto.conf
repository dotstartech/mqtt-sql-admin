# Standard MQTT listener
listener 1883

# WebSocket listener for browser clients (plain WS, TLS handled by nginx)
listener 9001 127.0.0.1
protocol websockets

# MQTT over TLS listener  
listener 8883
#certfile /mosquitto/security/server.crt
#keyfile /mosquitto/security/server.key

socket_domain ipv4

# If left unset, the default of allowing TLS v1.3 and v1.2
#tls_version tlsv1.3

# Configuration for client authentication with PKI (clients' certificates must be signed by the DFS CA represented by ca.crt)
#cafile /mosquitto/security/ca.crt
#require_certificate true

allow_anonymous false
per_listener_settings false

plugin /usr/lib/mosquitto_dynamic_security.so
plugin_opt_config_file /run/secrets/dynsec.json

plugin /usr/lib/libsql_plugin.so
# Exclude topics from being persisted to the database (comma-separated, supports MQTT wildcards + and #)
plugin_opt_exclude_topics cmd/#,+/test/exclude/#
# Batch insert configuration for performance tuning
plugin_opt_batch_size 100
plugin_opt_flush_interval 50
# Data retention: automatically delete messages older than N days (0 = disabled)
plugin_opt_retention_days 365
# Exclude MQTT message headers from being stored in the database (comma-separated list of header names, case-insensitive)
# Use '#' to disable headers storage completely
plugin_opt_exclude_headers header-to-exclude,another-header

persistence true
persistence_location /mosquitto/data

autosave_interval 1
autosave_on_changes true

connection_messages true

user admin

log_type information
log_dest stdout
log_dest file /mosquitto/log/mosquitto.log
log_timestamp_format %Y-%m-%dT%H:%M:%S